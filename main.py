import matplotlib.pyplot as plt
import numpy as np
from grid.structures import Domain, States, Regions
from grid.grid import Simulation

from matplotlib.animation import FuncAnimation, PillowWriter
from matplotlib.collections import LineCollection
from PIL import Image


niter = 200
scale = 1
lenN = 100

dt = 0.01
dx = 500 #km

Europe = Domain('maps/europe')
State = States(Europe, 150, 600, 0.001)
Provinces = Regions(State)

sim = Simulation(Provinces,
                 0.5, #maximum consumption rate per person (pop^-1.year^-1)
                 0.4, #population generated by max consumption (pop)
                 0.02, #pop natural death rate (year^-1)
                 10, #R needed to reach half of maximum consumption rate (res)
                 dt)

sim.random_city_state(lenN)
fig, ax = plt.subplots()
#plt.axis('off')


im=plt.imshow(sim.get_img())
scat = plt.scatter(sim.regions.cities.T[1], sim.regions.cities.T[0], s=1)
ax.set_title(f'Year: 0')


def animate(i):
    for _ in range(scale):
        sim.update()
    im.set_array(sim.get_img())
    ax.set_title(f'Year: {i*scale*dt}, {sim.regions.states.number} states, {sim.regions.number} cities')
    scat.set_offsets(np.c_[sim.regions.cities.T[1], sim.regions.cities.T[0]])

    print(f"step {i}\r", sep=' ', end='', flush=True)
    return [im]

writer = PillowWriter(fps=15)
anim = FuncAnimation(fig, animate, frames = niter, blit=False, interval = 100)
#anim.save('out.gif', writer=writer)
plt.show()
